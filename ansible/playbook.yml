- hosts: all
  become: true
  vars:
  - ansible_python_interpreter: /usr/bin/python3
  - db:
      name: sandbox
      user: foobar
      password: "{{ lookup('password', '.postgres-password') }}"

  tasks:
    - name: PostgreSQL is installed
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - libpq-dev
          - python3-psycopg2
        update_cache: true
        state: present
      tags: packages

    - name: PostgreSQL is running
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Database exists
      become_user: postgres
      postgresql_db:
        name: "{{ db.name }}"
        encoding: 'UTF-8'
        lc_collate: 'en_US.UTF-8'
        lc_ctype: 'en_US.UTF-8'
        template: 'template0'
        state: present

    - name: User has access to the database
      become_user: postgres
      postgresql_user:
        db: "{{ db.name }}"
        name: "{{ db.user }}"
        password: "{{ db.password }}"
        priv: ALL
        state: present

    - name: User does not have unnecessary privileges
      become_user: postgres
      postgresql_user:
        name: "{{ db.user }}"
        role_attr_flags: NOSUPERUSER,NOCREATEDB
        state: present
